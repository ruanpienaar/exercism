<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>/Users/rp/Dropbox/exercism/erlang/circular-buffer/_build/test/cover/eunit/circular_buffer.html</title>
</head><body style='background-color: white; color: black'>
<pre>
File generated from /Users/rp/Dropbox/exercism/erlang/circular-buffer/_build/test/lib/circular_buffer/ebin/../src/circular_buffer.erl by COVER 2018-01-25 at 16:46:00

****************************************************************************

        |  -module(circular_buffer).
        |  -export([ create/1,
        |            read/1,
        |            size/1,
        |            write/2,
        |            write_attempt/2
        |  ]).
        |  
        |  -export([test_version/0]).
        |  
        |  test_version() -&gt;
     1..|    1.
        |  %% Making an assumption that 8bits/Byte will be enough per element/block in buffer.
        |  create(Size) -&gt;
     6..|      spawn(fun() -&gt;
     6..|          cbuff(Size, 0, 0, &lt;&lt; &lt;&lt;X&gt;&gt; || &lt;&lt;X:8&gt;&gt; &lt;= &lt;&lt;0:(8*Size)&gt;&gt; &gt;&gt;)
        |      end).
        |  
        |  read(Pid) -&gt;
    12..|      req(Pid,read).
        |  
        |  size(Pid) -&gt;
     1..|      req(Pid,size).
        |  
        |  write(Pid,Val) -&gt;
    11..|      req(Pid,{write,Val}).
        |  
        |  write_attempt(Pid,Val) -&gt;
     2..|      req(Pid,{write_attempt,Val}).
        |  
        |  cbuff(Size,RPos,WPos,Buff) -&gt;
    32..|      receive
        |          {request,From,size} -&gt;
     1..|              reply(From,{ok,Size}),
     1..|              cbuff(Size,RPos,WPos,Buff);
        |          {request,From,read} -&gt;
    12..|              {Val,NewBuff,NewRPos}=do_read(Size,RPos,Buff),
    12..|              reply(From,Val),
    12..|              cbuff(Size,NewRPos,WPos,NewBuff);
        |          {request,From,{write, Val}} -&gt;
    11..|              {Reply,NewBuff,NewWPos}=do_write(Size,WPos,Val,Buff),
    11..|              reply(From, Reply),
    11..|              cbuff(Size,RPos,NewWPos,NewBuff);
        |          {request,From,{write_attempt,Val}} -&gt;
     2..|              {Reply,NewBuff,NewWPos}=do_write_attempt(Size,WPos,Val,Buff),
     2..|              reply(From,Reply),
     2..|              cbuff(Size,RPos,NewWPos,NewBuff)
        |          % {request, From,Req} -&gt;
        |          %     reply(From,{error,unknown_command}),
        |          %     cbuff(Size,RPos,WPos,Buff);
        |          % {system, From, _Msg = get_state} -&gt;
        |          %     gen:reply(From, {Size,RPos,WPos,Buff}),
        |          %     cbuff(Size,RPos,WPos,Buff);
        |          % X -&gt;
        |          %     cbuff(Size,RPos,WPos,Buff)
        |      end.
        |  
        |  req(Pid, Req) -&gt;
    26..|      Pid ! {request,self(),Req},
    26..|      receive
        |          {reply,Reply} -&gt;
    26..|              Reply
        |          after
        |              500 -&gt;
<font color=red>     0..|                  {error,timeout}</font>
        |      end.
        |  
        |  reply(Pid,Reply) -&gt;
    26..|      Pid ! {reply,Reply}.
        |  
        |  do_read(Size,Pos,Buff) -&gt;
        |      % io:format("do_read(~p)~n", [[Size,Pos,Buff]]),
    12..|      case do_read_attempt(Pos,Buff) of
        |          0 -&gt;
     2..|              {{error,empty},Buff,Pos};
        |          V -&gt;
    10..|              {{ok,V},new_buffer(Size,Buff,Pos,0),next_pos(Size,Pos)}
        |      end.
        |  
        |  do_read_attempt(Pos,Buff) -&gt;
    14..|      binary:at(Buff,Pos).
        |  
        |  do_write(Size,Pos,Val,Buff) -&gt;
    12..|      {ok,new_buffer(Size,Buff,Pos,Val),next_pos(Size,Pos)}.
        |  
        |  do_write_attempt(Size,Pos,Val,Buff) -&gt;
     2..|      case do_read_attempt(Pos,Buff) of
        |          0 -&gt;
     1..|              do_write(Size,Pos,Val,Buff);
        |          V -&gt;
     1..|              {{error,full},Buff,Pos}
        |      end.
        |  
        |  next_pos(Size,Pos) when (Pos+1) == Size -&gt;
     9..|      0;
        |  next_pos(Size,Pos) when Pos &lt; Size -&gt;
    13..|      Pos+1.
        |  
        |  new_buffer(1,Buff,0,NewVal) -&gt;
     2..|      &lt;&lt;NewVal:8&gt;&gt;;
        |  new_buffer(Size, Buff, 0, NewVal) -&gt;
     9..|      Tail = binary:part(Buff, 1, Size-1),
     9..|      &lt;&lt;NewVal:8, Tail/binary&gt;&gt;;
        |  new_buffer(Size, Buff, Pos, NewVal) when (Pos+1) =:= Size -&gt;
     7..|      Head = binary:part(Buff, 0, Size-1),
     7..|      &lt;&lt;Head/binary, NewVal:8&gt;&gt;;
        |  new_buffer(Size, Buff, Pos, NewVal) -&gt;
     4..|      Head = binary:part(Buff, 0, Pos),
     4..|      Tail = binary:part(Buff, Pos+1, Size-2),
     4..|      &lt;&lt;Head/binary, NewVal:8, Tail/binary&gt;&gt;.</pre>
</body>
</html>
